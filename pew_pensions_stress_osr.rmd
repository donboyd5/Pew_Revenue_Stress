---
title: "Own-source revenue for pension stress tests"
author: "Don Boyd"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook:
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
  html_document:
    toc: yes
    df_print: paged
editor_options:
  chunk_output_type: console
---


```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE)
options(width = 150)
```


```{r globals}


```


```{r libraries, include=FALSE}
source(here::here("include", "libraries.r"))
devtools::session_info()
```

<!--
Note:

-->


# Constructing state OSR forecasts - introduction

Goal is to forecast state own-source revenue (osr) and components using a method that:

*   is compatible with a state's own short-term forecasts,
*   stabilizes in the longer term to grow at the rate of state gdp, and
*   can be applied to individual states with a minimal amount of digging for new information


Key forecast elements:

*   State own-source revenue and major components
    +   using Census definitions
    +   state fiscal years (periods ending in June)
    +   nominal
    +   $ millions
    +   2021 through 2030
    
*   National economic forecast - uses one of the relatively current forecasts provided by Pew:
    +   CBO July 2020 (baseline)
    +   Moody's December 2020, p50 (baseline) - the most-current full forecast we have
    +   Moody's July 2020, p50
    +   Moody's July 2020, p90 (S3 - severe stress scenario)
    +   (We also have available a Moody's December 2019 baseline forecast, not used)
    +   Federal Reserve alternative severe forecast
    
*   State economic forecast:
    +   available state GDP forecasts are Moody's baseline forecasts released in December 2019, July 2020, and December 2020, each of which also has an associated Moody's national forecast
    +   to get state GDP forecasts under different national scenarios, I assume the difference between a state's growth rate and the national growth rate is the same as it is in the most-recent Moody's forecast (December 2020)
    

Overall approach for OSR and components:

*   2019 and earlier - Census
*   2020 - tax growth rates from Census quarterly data; nontax based on state GDP estimate
*   2021 uses growth rates from a state governmental forecast, or inferred from those forecasts:
    +   currently uses the governor's August 2020 estimate
    +   note that governor raised his estimate in Nov 2020 by [$398 million](https://www.nj.gov/treasury/news/2020/11062020.shtml); this is not yet reflected but can be
    +   also note that OLS estimate is about $1.3 billion higher than gov August, could be used as an alternative forecast for 2021
*   2022-2024 taxes move in equal annual increments, as % of GDP, from their 2021 % of GDP to their presumed long-term % of GDP (the presumed long-term % of GDP is the average observed for the 3 years ending in 2019)
    +   thus, sources that declined most sharply will bounce back most sharply
*   2025-2030 - all osr components are a constant % of GDP - their presumed long-term average (thus, all osr components grow at the same rate as state GDP)


Selected issues and considerations:

*   It is a forecast under a single scenario - does not consider possible impact of stock market declines, for example; these are possible extensions
*   Uses Census definitions of OSR and thus is different from what policymakers in NJ are familiar with
*   Assumes all revenue sources move from their 2021 values to longer term values, as % of GDP; historically, other tax revenue has tended to decline as % of GDP until policymakers explicitly raise it
*   Because the 2021 OSR estimate is based on a fixed governmental forecast, and is independent of the economic forecast, it may seem odd in relation to a severe-downturn economic forecast for FY 2021 - in particular, OSR as a percent of GDP is unusually high in 2021 when using the Moody's p90 forecast (because gdp is so low in that forecast)
*   Because OSR as % of GDP was rising in years leading up to recession, it reverts to a high level. This reflects recent tax-increase choices, I think.


# National economic forecasts

The plot below shows available nominal GDP forecasts on a July-June state fiscal year basis. (Each year ends in June. For example, the 2021 forecast is for the 12 months ending in June 2021.)

The Moody's Dec 2020 baseline forecast is far more optimistic than the CBO July baseline, reflecting the positive economic news received since July. It  and is more plausible than the CBO baseline. The Moody's July baseline also was more optimistic than CBO July, but not nearly as much.


```{r eval=TRUE, include=TRUE}
# look at the national forecasts
usgdp <- readRDS(here::here("data", "usgdp_spliced.rds"))

```


```{r natfc, include=TRUE, fig.width=10, fig.height=6}

fcs <- c("cbo_jul2020", "cbo_precovid", "moodys_dec2020p50", "fed_alt")

usgdp %>%
  # filter(year >= 2015, src %in% fcs) %>%
  filter(year >= 2015) %>%
  ggplot(aes(year, value, colour=src)) +
  geom_line(size=1) +
  geom_point() +
  ggtitle("National forecasts of nominal GDP, state fiscal year basis") +
  theme_bw()

```


# State growth vs national growth in the Moody's December 2020 baseline forecast

```{r}
# get data
# look at national-state differences
dfl <- readRDS(here::here("data", "gdpstus_moodys_dec2020.rds"))

# sts <- c("CA", "CO", "FL", "MA", "NJ","NY", "PA", "IL")
sts <- c("MA", "NJ")

```



## National growth and state growth
```{r include=TRUE, fig.width=10, fig.height=6}
data <- dfl %>%
  filter(name %in% c("pch", "pchus"), stabbr %in% sts) %>%
  mutate(name=factor(name, levels=c("pch", "pchus"), labels=c("state", "US")))

data %>%
  filter(year %in% 2000:2030) %>%
  ggplot(aes(year, value, colour=name)) +
  geom_line(size=1) +
  geom_point() +
  scale_colour_manual(values=c("blue", "darkgreen")) +
  # geom_hline(yintercept = 0) +
  geom_vline(xintercept = 2020.5, linetype="dotted") +
  scale_y_continuous(name="% change", breaks=seq(-10, 20, 1)) +
  facet_wrap(~stabbr) +
  ggtitle("Nominal GDP growth, state fiscal year basis, selected states, Moody's December 2020 forecast",
          subtitle="Dotted vertial line marks break between history and forecast") +
  theme_bw()

```


## State growth minus national growth
```{r include=TRUE, fig.width=10, fig.height=6}
data <- dfl %>%
  filter(name=="pdelta", stabbr %in% sts)

avgstart <- 2000
avgend <- 2020
avgs <- data %>%
  filter(year %in% avgstart:avgend) %>%
  group_by(stabbr) %>%
  summarise(avg=mean(value), .groups="drop")

data %>%
  filter(year >= 2000, year <= 2030) %>%
  ggplot(aes(year, value)) +
  geom_line(colour="blue", size=1) +
  geom_point(colour="blue") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 2020.5, linetype="dotted") +
  geom_hline(aes(yintercept=avg), colour="red", size=0.4, data=avgs) +
  scale_y_continuous(name="State % change minus US % change", breaks=seq(-10, 10, 1)) +
  scale_x_continuous(name="State fiscal year", breaks=seq(1980, 2050, 5)) +
  facet_wrap(~stabbr, ncol=2, scales="fixed") +
  ggtitle("Nominal GDP growth: State minus nation, selected states, Moody's December 2020 forecast",
          subtitle=paste0("Red horizontal line is average over ", avgstart, "-", avgend,
                          ". Dotted vertial line marks break between history and forecast.")) +
  theme_bw()
```


# OSR history and forecasts

```{r get_data}
usgdp <- readRDS(here::here("data", "usgdp_spliced.rds"))
stgdp <- readRDS(here::here("data", "stgdp_spliced.rds"))
osr <- readRDS(here::here("data", "osr_census_updated.rds")) # ends 2020

```


```{r get_assumptions}
fn <- "assumptions.xlsx"
assume <- read_excel(here::here("data", fn), sheet="osr_forecasts") %>%
  filter(!is.na(stabbr))
assume

# forecast 2021
natfc <- "cbo_jul2020"
stfc <- "ols_sep2020"  # for NJ




nontax_growth2021 <- 0  # must assume as we don't have a forecast, NJ growth rate
pctgdp_years <- 3 # number of years we use to determine osr target pct of gdp
recover_years <- 4  # number of years from trough to return to target % of gd p

gov_forecast <- "govaugxleg"  # govbmxleg, govaugxleg, olssepxleg

osrvars <- c("iit", "gst", "cit", "othertax", "nontax") # define the desired order

keyvars <- c("cit_census", "gst_census", "iit_census", "othertax_census",
           "nontax_census", "osr_census", "gdp_beaspliced")

```





# OLDER stuff

```{r output, echo=FALSE, include=TRUE, results="asis", eval=FALSE}
# https://stackoverflow.com/questions/36373630/how-to-create-a-loop-that-includes-both-a-code-chunk-and-text-with-knitr-in-r
# to loop, need:
#  include=TRUE, results="asis"
#  2 spaces before \n

# echo=FALSE, fig.keep = 'all',  results = 'asis',  message=FALSE, warning=FALSE, comment =NA, fig.align='center', fig.height=6.5,  fig_width=10

vars <- c("a", "b", "c")

for (var in vars) {
  cat("  \n")
  cat("#",var,"\n")
}


```  


```{r outputs2, fig.width=6, echo=FALSE, include=TRUE, message=FALSE, results="asis", eval=FALSE}
library(pander)

vars <- c("st1", "st2", "st3")

for (var in vars) {
  # Inserts Month titles
  pander::pandoc.header(var, level = 2)
  # Section contents
  cat(paste0("Some text about state ", var))
  # plot(pressure)
  # adding also empty lines, to be sure that this is valid Markdown
  pander::pandoc.p('')
  pander::pandoc.p('')
}


# for (i in unique(airquality$Month)) {
#    # Inserts Month titles
#    pander::pandoc.header(month.name[i], level = 3)
#    # Section contents
#    plot(airquality[airquality$Month == i,])
#    # adding also empty lines, to be sure that this is valid Markdown
#    pander::pandoc.p('')
#    pander::pandoc.p('')
# }
```



# NJ forecast - results


```{r parameters, include=FALSE}
nontax_growth2021 <- 0  # must assume as we don't have a forecast, NJ growth rate
pctgdp_years <- 3 # number of years we use to determine osr target pct of gdp
recover_years <- 4  # number of years from trough to return to target % of gd p

gov_forecast <- "govaugxleg"  # govbmxleg, govaugxleg, olssepxleg

osrvars <- c("iit", "gst", "cit", "othertax", "nontax") # define the desired order

keyvars <- c("cit_census", "gst_census", "iit_census", "othertax_census",
           "nontax_census", "osr_census", "gdp_beaspliced")

```


```{r}
# year value src name
usgdp <- readRDS(here::here("data", "usgdp_spliced.rds"))
stgdp <- readRDS(here::here("data", "stgdp_spliced.rds"))

gdp <- stgdp %>%
  rename(stgdp=value) %>%
  left_join(usgdp %>% select(year, src, usgdp=value),
             by = c("year", "src")) %>%
  select(src, stabbr, year, usgdp, stgdp) %>%
  arrange(src, stabbr, year)

# tax data Census
# assumptions

# and then go!

# cat("\n\n", "# Data Cleaning - Outputs", "\n\n")

```



```{r OLD_getdata, include=FALSE}
combo <- readRDS(here::here("data", "combo.rds"))

combotab <- combo %>%
  group_by(fullname) %>%
  summarise(n=n(),
            n_notNA=sum(!is.na(value)),
            first_year=min(year),
            last_year=max(year),
            nyears=last_year - first_year + 1,
            nstates=length(unique(stabbr)),
            nus=sum(stabbr=="US", na.rm = TRUE),
            nnj=sum(stabbr=="NJ", na.rm = TRUE),
            minval=min(value, na.rm=TRUE),
            maxval=max(value, na.rm=TRUE),
            .groups="drop") %>%
  select(fullname, n, n_notNA, nyears, everything())
combotab

```


```{r gov_forecasts, include=FALSE}
# we need 2021 growth rates for each source
# note that we just need iit, gst, cit, othertax, and nontax growth rates
# we'll compute total growth rates and osr growth rates

# govaugxleg and olssepxleg are possible forecasts
taxgrowth <- combo %>%
  filter(str_detect(fullname, "xleg")) %>%
  group_by(src, name) %>%
  arrange(year) %>%
  mutate(pch=value / value[match(year - 1, year)] * 100 - 100) %>%
  ungroup %>%
  filter(year == 2021) %>%
  select(year, name, pch, src) %>%
  pivot_wider(values_from = pch)

# add the nontax growth rate
taxgrowth <- taxgrowth %>%
  mutate(nontax=nontax_growth2021)

taxgrowth

taxgrowth_long <- taxgrowth %>%
  pivot_longer(-c(year, src), values_to = "pch")

```



```{r osr_LR_target, include=FALSE}

# Compute long-run target revenue as % of gsp

pctgdp <- combo %>%
  filter(fullname %in% keyvars, stabbr=="NJ", year >= 1964, year <= 2019) %>% # so we always have gdp
  select(year, name, value) %>%
  group_by(year) %>%
  mutate(gdp=value[name=="gdp"], 
         pctgdp=value / gdp * 100) %>%
  filter(name != "gdp") %>%
  group_by(name) %>%
  arrange(year) %>%
  mutate(mapct=ma(pctgdp, n=pctgdp_years)) %>%
  select(year, name, mapct) %>%
  pivot_wider(values_from = mapct)

# pctgdp %>%
#   filter(year >= 1980) %>%
#   pivot_longer(-year) %>%
#   filter(!name %in% c("osr")) %>%
#   ggplot(aes(year, value, colour=name)) +
#   geom_line() +
#   geom_point()

targets <- pctgdp %>%
  filter(year==max(year)) %>%
  pivot_longer(-year, values_to = "targetpct")
targets

```



```{r forecast, include=FALSE}
# Put it all together
# history to 2020
# govt growth rates to 2021
# phase toward the long run over x years
# then implement the long run

# we need our spliced national and state gdp forecasts
usgdp <- readRDS(here::here("data", "usgdp_spliced.rds"))
njgdp <- readRDS(here::here("data", "njgdp_spliced.rds"))

(start_year <- max(min(usgdp$year), min(njgdp$year)))

econdata <- bind_rows(usgdp %>%
                        mutate(name="gdp", stabbr="US") %>%
                        select(year, name, stabbr, value, src),
                      njgdp %>%
                        select(year, name, stabbr, value, src)) %>%
  filter(year >= start_year)
count(econdata, name)
count(econdata, stabbr)
count(econdata, src)
econw <- econdata %>%
  pivot_wider(names_from = stabbr)

# now we need tax data, which will be the same
osrtax <- combo %>%
  filter(src=="census", stabbr=="NJ", year >= min(econw$year), name %in% osrvars) %>%
  select(year, name, value) %>%
  mutate(name=factor(name, levels=osrvars)) %>%
  arrange(year, name) %>%
  pivot_wider() %>%
  replace_na(list(cit = 0))

fcdata <- econw %>%
  filter(name=="gdp") %>%
  select(year, src, gdpUS=US, gdpNJ=NJ) %>%
  left_join(osrtax, by="year")
summary(fcdata)

# compute 2021 based on government forecast
d2021 <- fcdata %>%
  pivot_longer(-c(year, src, gdpUS, gdpNJ)) %>%
  left_join(taxgrowth_long %>% 
              filter(src==gov_forecast) %>% 
              select(year, name, pch), 
            by = c("year", "name")) %>%
  group_by(src, name) %>%
  mutate(value=ifelse(year==2021, value[year==2020] * (1 + pch / 100), value),
         pctgdp=value / gdpNJ * 100)
  
# now compute % gdp and gap vs target
# define # of years it will take to return to target
fcast <- d2021 %>%
  select(-pch) %>%
  left_join(targets %>% select(name, targetpct),
            by="name") %>%
  mutate(gap=ifelse(year >= 2015, pctgdp - targetpct, NA_real_),
         years_from_start=case_when(year <= 2021 ~ 0,
                              year  %in% 2022:(2021 + recover_years) ~ year - 2021,
                              TRUE ~ 0),
         initial_gap = gap[year==2021],
         initial_pct = pctgdp[year==2021],
         pctgdp_new=case_when(year <= 2021 ~ NA_real_,
                              year %in% 2022:(2021 + recover_years) ~ 
                                initial_pct - initial_gap * years_from_start / recover_years,
                              year > (2021 + recover_years) ~ targetpct,
                              TRUE ~ -999),
         value=ifelse(year >= 2022,
                      gdpNJ * pctgdp_new / 100,
                      value)) %>%
  ungroup


# fcast %>%
#   filter(name=="gst", year >= 2010, src!="cbo_precovid") %>%
#   ggplot(aes(year, value, colour=src)) +
#   geom_line() +
#   geom_point()


fc_wide <- fcast %>%
  select(year, src, gdpUS, gdpNJ, name, value) %>%
  arrange(src, year, name) %>%
  pivot_wider() %>%
  mutate(tottax=iit + gst + cit + othertax,
         osr=tottax + nontax)
  
# fcast %>%
#   filter(src!="cbo_precovid", year >= 2015) %>%
#   ggplot(aes(year, osr, colour=src)) +
#   geom_line() +
#   geom_point()

# fc_wide %>%
#   filter(src!="cbo_precovid", year >= 2015) %>%
#   ggplot(aes(year, osr / gdpNJ * 100, colour=src)) +
#   geom_line() +
#   geom_point()

# fcast %>%
#   group_by(src) %>%
#   mutate(osrpct=osr / osr[match(year - 1, year)] * 100 - 100) %>%
#   filter(src!="cbo_precovid", year >= 2015) %>%
#   ggplot(aes(year, osrpct, colour=src)) +
#   geom_line() +
#   geom_point() +
#   geom_hline(yintercept = 0) +
#   scale_x_continuous(breaks=seq(2010, 2040, 2)) +
#   scale_y_continuous(breaks=seq(-20, 20, 2))


```


## Tables

```{r prep, include=FALSE}
vars <- c("iit", "gst", "cit", "othertax", "tottax", "nontax", "osr")

```


### CBO July 2020 forecast

#### Dollar amounts
```{r include=TRUE}
data <- fc_wide %>%
  filter(src=="cbo_jul2020", year >= 2019) %>%
  select(year, any_of(vars))

tab <- data %>%
  gt() %>%  
  tab_header(
      title = "New Jersey own-source revenue, $ millions",
      subtitle = "National forecast: CBO July 2020 baseline"
    ) %>%
    cols_label(
      year=html("State fiscal year<br>ending in:")
    ) %>%
    fmt_currency(
      columns = vars,
      rows=1,
      decimals = 0,
      scale_by = 1,
      suffixing = FALSE
    ) %>%
    fmt_number(
      columns = vars,
      rows=2:nrow(data),
      decimals = 0,
      scale_by = 1,
      suffixing = FALSE
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = "#f7f7f7")
      ),
      locations = cells_body(
        rows = seq(1, nrow(data), 2)
        )
    ) %>%
    tab_source_note("OSR categories use Census-definitions")

tab

```

### % Change
```{r include=TRUE}
data <- fc_wide %>%
  filter(src=="cbo_jul2020", year >= 2018) %>%
  select(year, any_of(vars)) %>%
  arrange(year) %>%
  mutate(across(any_of(vars), ~ . / lag(.) * 100 - 100)) %>%
  filter(year >= 2019)

tab <- data %>%
  gt() %>%  
  tab_header(
      title = "New Jersey own-source revenue, % change",
      subtitle = "National forecast: CBO July 2020 baseline"
    ) %>%
    cols_label(
      year=html("State fiscal year<br>ending in:")
    ) %>%
    fmt_percent(
      columns = vars,
      # rows=1:nrow(data),
      decimals = 1,
      scale_values = FALSE
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = "#f7f7f7")
      ),
      locations = cells_body(
        rows = seq(1, nrow(data), 2)
        )
    ) %>%
    tab_source_note("OSR categories use Census-definitions")

tab
```



## Graphs

Note: In the graphs that follow, all series have the same (actual) history but only one of the lines will be visible.

### Forecast comparison - levels
```{r include=TRUE}
fc_wide %>%
  filter(year >= 2015, src!="cbo_precovid") %>%
  ggplot(aes(year, osr, colour=src)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(name="$ millions", breaks=seq(20e3, 80e3, 5e3), labels=comma) +
  scale_x_continuous(name="State fiscal year", breaks=seq(2010, 2040, 2)) +
  ggtitle("New Jersey own-source revenue, $ millions",
          subtitle="Alternative national economic forecasts") +
  theme_bw()

```


### Forecast comparison - % change
```{r include=TRUE}
fc_wide %>%
  group_by(src) %>%
  mutate(pch=osr / osr[match(year - 1, year)] * 100 - 100) %>%
  filter(year >= 2015, src!="cbo_precovid") %>%
  ggplot(aes(year, pch, colour=src)) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = 0) +
  scale_y_continuous(name="% change", breaks=seq(-10, 20, 1)) +
  scale_x_continuous(name="State fiscal year", breaks=seq(2010, 2040, 2)) +
  ggtitle("New Jersey own-source revenue, % change from previous year",
          subtitle="Alternative national economic forecasts") +
  theme_bw()

```


### Forecast comparison - % of GDP
```{r include=TRUE}
fc_wide %>%
  group_by(src) %>%
  filter(year >= 2010, src!="cbo_precovid") %>%
  mutate(pctgdp=osr / gdpNJ * 100) %>%
  ggplot(aes(year, pctgdp, colour=src)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(name="% of state GDP", breaks=seq(1, 20, 0.2)) +
  scale_x_continuous(name="State fiscal year", breaks=seq(2010, 2040, 2)) +
  ggtitle("New Jersey own-source revenue, % of state GDP",
          subtitle="Alternative national economic forecasts") +
  theme_bw()

```


