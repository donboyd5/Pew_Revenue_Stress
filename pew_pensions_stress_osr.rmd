---
title: "Own-source revenue for pension stress tests"
author: "Don Boyd"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook:
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
  html_document:
    toc: yes
    df_print: paged
editor_options:
  chunk_output_type: inline
---


```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE, fig.width=10, fig.height=6)
options(width = 150)
```


```{r globals}


```


```{r libraries, include=FALSE}
source(here::here("include", "libraries.r"))
devtools::session_info()
```

<!--
Note:

-->


# Goals and methods: Constructing state OSR forecasts

## Goals

Goal is to forecast state own-source revenue (osr) and components using a method that:

*   is compatible with a state's own short-term forecasts,
*   stabilizes in the longer term to grow at the rate of state gdp, and
*   can be applied to individual states with a minimal amount of digging for new information


Key forecast elements:

*   State own-source revenue and major components
    +   using Census definitions
    +   state fiscal years (periods ending in June)
    +   nominal
    +   $ millions
    +   2021 through 2030
    
*   National economic forecast - uses one of the relatively current forecasts provided by Pew:
    +   CBO July 2020 (baseline)
    +   Moody's December 2020, p50 (baseline) - the most-current full forecast we have
    +   Moody's July 2020, p50
    +   Moody's July 2020, p90 (S3 - severe stress scenario)
    +   (We also have available a Moody's December 2019 baseline forecast, not used)
    +   Federal Reserve alternative severe forecast
    
*   State economic forecast:

    +   available state GDP forecasts are Moody's baseline forecasts released in December 2019, July 2020, and December 2020, each of which also has an associated Moody's national forecast
    +   to get state GDP forecasts under different national scenarios, I assume the difference between a state's growth rate and the national growth rate is the same as it is in the most-recent Moody's forecast (December 2020)

*   Equity return forecasts - factor into capital gains forecasts, which in turn affect the income tax. There are two equity return forecasts (domestic equities)
    +   pew_baseline -- the Pew Covid baseline -- **Note that this is not consistent with the CBO July 2020 economic forecast**
    +   pew_fedalt
    
*   Capital gains forecasts

    +   From a simple model based upon national GDP, S&P 500, and capital gains history
    +   Forecast varies depending on which national GDP forecast is used and which equity forecast is used
  

Overall approach for OSR and components:

*   2019 and earlier - Census
*   2020 - tax growth rates from Census quarterly data; nontax based on state GDP estimate
*   2021 uses growth rates from a state governmental forecast, or inferred from those forecasts; nontax revenue assumed to grow at rate of state GDP
*   2022-2024 taxes are from simple models:
    +   income tax based upon state GDP, national capital gains, and its own history
    +   other tax categories based upon state GDP and the tax's own history
    +   nontax revenue assumed to grow at the rate of GDP
*   2025-2030 - all osr components are a constant % of GDP - their presumed long-term average (thus, all osr components grow at the same rate as state GDP)

Scenarios: Three factors determine a scenario

*   Which national economic forecast is used
*   Which equity forecast is used
*   Which governmental short-term forecast is used

Some combinations of these will not make sense (e.g., fedalt equity forecast might not make sense to combine with the CBO pre-covid economic forecast).

Currently I am using the Moody's December 2020 economic forecast as the best economic forecast. I know you prefer CBO July. We should discuss.

Here are the scenarios I am using (as of now):


  stabbr govtfc      econfc         equityfc      scenario

  NJ     ols_sep2020 moodys_dec2020 pew_covidbase baseline
  NJ     gov_aug2020 fedalt         pew_fedalt    downside
  NJ     gov_bmxleg  cbo_precovid   pew_covidbase precovid
  
  MA     bhi_oct2020 moodys_dec2020 pew_covidbase baseline


Selected issues and considerations:

*   Uses Census definitions of OSR and thus is different from what policymakers in NJ are familiar with
*   Assumes all revenue sources move from their 2021 values to longer term values, as % of GDP; historically, other tax revenue has tended to decline as % of GDP until policymakers explicitly raise it
*   Because the 2021 OSR estimate is based on a fixed governmental forecast, and is independent of the economic forecast, it may seem odd in relation to a severe-downturn economic forecast for FY 2021 - in particular, OSR as a percent of GDP is unusually high in 2021 when using the Moody's p90 forecast (because gdp is so low in that forecast)

## Data sources [details to come]

*   US GDP history: BEA NIPA tables, quarterly converted to state fiscal year (July-June)
*   State GDP history: BEA data, spliced NAICS and SIC; quarterly converted to state fiscal year, adjusted
*   US GDP forecasts:
    +   CBO pre-covid


# Preliminaries

```{r functions}
pch <- function(df){
  df2 <- df %>%
    mutate(pch=value / value[match(year - 1, year)] * 100 - 100)
  df2$pch
}

stname <- function(stabbr){
  state.name[state.abb == stabbr]
}

```


```{r get_data}
# get data
usgdp <- readRDS(here::here("data", "usgdp.rds"))
stgdp <- readRDS(here::here("data", "stgdp.rds"))

sp500tr3 <- readRDS(here::here("data", "sp500tr.rds"))
cg <- readRDS(here::here("data", "uscapgains.rds"))
cgmodel <- readRDS(here::here("data", "cgmodel.rds"))
cgfcast <- readRDS(here::here("data", "cgfcast.rds"))

osr <- readRDS(here::here("data", "osr_census_updated.rds")) %>% # ends 2020
  mutate(value=value / 1000)  %>% # put in $ millions
  arrange(stabbr, name, year) %>%
  group_by(stabbr, name) %>%
  mutate(pch=value / value[match(year - 1, year)] * 100 - 100) %>%
  ungroup

osr_pctgdp <- readRDS(here::here("data", "osr_pctgdp.rds"))

targets <- osr_pctgdp %>%
  pivot_longer(cols=starts_with("p"), values_to = "targetpct", names_to = "ma_years") %>%
  mutate(ma_years=str_sub(ma_years, 2, -1) %>% as.integer)
# targets

```



```{r get_assumptions, include=FALSE}
fn <- "assumptions.xlsx"

assume <- read_excel(here::here("data", fn), sheet="osr_forecasts") %>%
  filter(!is.na(stabbr)) %>%
  # convert to percentage
  mutate(across(c(iit, cit, gst, othertax, nontax), ~ . * 100))
assume

# assumecg <- read_excel(here::here("data", fn), sheet="cgboyd", skip=3) %>%
#   filter(year >= 1996)
# assumecg

```



## National economic forecasts

The plot below shows available nominal GDP forecasts on a July-June state fiscal year basis. (Each year ends in June. For example, the 2021 forecast is for the 12 months ending in June 2021.)

The Moody's Dec 2020 baseline forecast is far more optimistic than the CBO July baseline, reflecting the positive economic news received since July. It is more plausible than the CBO baseline. The Moody's July baseline also was more optimistic than CBO July, but not nearly as much.


```{r natfc, include=TRUE, fig.width=10, fig.height=6}

fcorder <- c("cbo_precovid", "cbo_jul2020", "moodys_jul2020p50", "moodys_jul2020p90",
             "moodys_dec2020", "fedalt")

usgdp %>%
  filter(year >= 2015) %>%
  select(-gdphist) %>%
  pivot_longer(-year, names_to = "forecast") %>%
  mutate(forecast=factor(forecast, level=fcorder)) %>%
  arrange(forecast) %>%
  ggplot(aes(year, value / 1e3, colour=forecast)) +
  geom_line(size=1) +
  geom_point() +
  scale_y_continuous(name="$ billions", breaks=seq(10e3, 50e3, 2.5e3), labels=scales::comma) +
  scale_x_continuous(name="State fiscal year", breaks=seq(2010, 2040, 2)) +
  ggtitle("National forecasts of nominal GDP, state fiscal year basis") +
  theme_bw()

```


## National forecasts: Stock market and capital gains

Capital gains are important to state income taxes, as will be apparent when we look at individual states.

We have a small model that estimates capital gains based upon GDP, the stock market (S&P 500), and their own history.

Here are fit statistics from the model:

`r fabletools::report(cgmodel)`


```{r include=TRUE}
report(cgmodel)
```

Here is a plot of how well/poorly the model does over history.

```{r cgfit, include=TRUE, fig.width=10, fig.height=6}

cgmodel %>% 
  augment() %>%
  select(year, actual=cg, fitted=.fitted) %>%
  pivot_longer(-year, names_to = "type") %>%
  ggplot(aes(year, value, colour=type)) +
  geom_line(size=1) +
  geom_point() +
  scale_colour_manual(values=c("blue", "darkgreen")) +
  scale_x_continuous(name="Calendar year", breaks=seq(1990, 2020, 2)) +
  scale_y_continuous(name="$ billions", labels = scales::comma) +
  ggtitle("Model fit for national capital gains model") +
  theme_bw()

```

We used this model to forecast capital gains under different economic forecasts, using the baseline and fedalt equity return assumptions. Here are the forecasts under selected economic forecast and equity-return assumption combinations.

The combination of the fedalt economic scenario plus the fedalt equity-return assumptions results in large capital gains reductions and will have large impacts on state personal income tax forecasts.


```{r cgfc, include=TRUE, fig.width=10, fig.height=6}

cgfcast %>%
  filter(year >= 2015) %>%
  filter((gdpname=="cbo_precovid" & eqname=="pew_covidbase") |
         (gdpname=="cbo_jul2020" & eqname=="pew_covidbase") |
         (gdpname=="moodys_dec2020" & eqname=="pew_covidbase") |
         (gdpname=="fedalt" & eqname=="pew_covidbase") |
         (gdpname=="fedalt" & eqname=="pew_fedalt")) %>%
  mutate(grp=paste0(gdpname, "-", eqname)) %>%
  ggplot(aes(year, cgfcast, colour=grp)) +
  geom_line(size=1) +
  geom_point() +
  scale_x_continuous(name=NULL, breaks=seq(1990, 2040, 2)) +
  scale_y_continuous(name="$ billions", labels = scales::comma) +
  ggtitle("Model forecasts of capital gains",
          subtitle="Selected economic-equity forecast combinations") +
  theme_bw()


```


# State Own-Source Revenue analysis and forecasts

```{r state_data_prep}
# prep data for all states, then draw as needed for individual states
stusgdp <- bind_rows(usgdp %>% mutate(stabbr="US"),
                     stgdp) %>%
  pivot_longer(-c(year, stabbr), names_to = "forecast") %>%
  group_by(forecast, stabbr) %>%
  mutate(pch=value / value[match(year - 1, year)] * 100 -100) %>%
  ungroup

stgdp_uswide <- stusgdp %>%
  group_by(forecast, year) %>%
  mutate(usgdp=value[stabbr=="US"],
         usgdp_pch=pch[stabbr=="US"]) %>%
  ungroup %>%
  filter(stabbr != "US", year >= 1965) %>%
  rename(stgdp=value, stgdp_pch=pch)

capgains <- cgfcast %>%
  select(year, gdpname, eqname, capgains=cgfcast) %>%
  group_by(gdpname, eqname) %>%
  mutate(capgains_lag=capgains[match(year - 1, year)],
         capgains_pch=capgains / capgains_lag * 100 - 100) %>%
  ungroup

gdposr_pch <- stgdp %>%
  select(stabbr, year, gdp=moodys_dec2020) %>%
  inner_join(osr %>% 
               filter(name=="osr") %>% 
               select(stabbr, year, osr=value),
             by = c("stabbr", "year")) %>%
  pivot_longer(cols=-c(year, stabbr)) %>%
  group_by(stabbr, name) %>%
  mutate(pch=value / value[match(year - 1, year)] * 100 - 100) %>%
  ungroup %>%
  filter(year > min(year))

# State GDP, capital gains, and income tax
iit_gdpcg <- stgdp %>%
  select(year, stabbr, gdp=moodys_dec2020) %>%
  inner_join(osr %>% 
               filter(name=="iit") %>% 
               select(stabbr, year, iit=value),
             by = c("year", "stabbr")) %>%
  inner_join(cg %>% 
               select(year, capgains=cbo_jul2020) %>%
               mutate(cglagged=capgains[match(year -1, year)]),
             by="year") %>%
  pivot_longer(-c(year, stabbr)) %>%
  group_by(stabbr, name) %>%
  mutate(pch=value / value[match(year - 1, year)] * 100 - 100) %>%
  ungroup


```


```{r define_scenarios}
# prepare forecast data
# first construct the short-term state forecasts for nontax revenue -- set equal to state gdp growth

# define scenarios as combinations of:

#   states & state govt forecasts
    # MA     bhi_oct2020       
    # MA     boyd_baseline

    # NJ     gov_aug2020      
    # NJ     gov_bmxleg       
    # NJ     ols_sep2020

#   national forecasts
    # cbo_precovid
    # cbo_jul2020
    # fedalt
    # moodys_jul2020p50
    # moodys_jul2020p90
    # moodys_dec2020

#   equity forecasts
#     pew_covidbase
#     pew_fedalt

scenarios <- tribble(
  ~stabbr, ~govtfc, ~econfc, ~equityfc, ~scenario,
  
  "NJ", "ols_sep2020", "moodys_dec2020", "pew_covidbase",  "baseline",
  "NJ", "gov_aug2020", "fedalt", "pew_fedalt", "downside",
  "NJ", "gov_bmxleg", "cbo_precovid", "pew_covidbase", "precovid",
  
  "MA", "bhi_oct2020", "moodys_dec2020", "pew_covidbase",  "baseline",
  # "MA", "boyd_baseline"  # baseline
)


```


```{r}
# construct dataframe that will hold forecasts
osrvars <- c("iit", "gst", "cit", "othertax", "nontax")

# create a base data frame to hold forecasts
base <- scenarios %>%
  inner_join(stgdp_uswide %>% 
               rename(econfc=forecast),
             by = c("stabbr", "econfc")) %>%
  left_join(capgains %>% 
              rename(econfc=gdpname, equityfc=eqname),
            by = c("econfc", "equityfc", "year")) %>%
  full_join(tibble(revtype=osrvars), by=character()) %>%  # create a record for each revtype!
  left_join(osr %>% 
              filter(name %in% osrvars) %>% 
              rename(revtype=name, rev=value, rev_pch=pch),
            by = c("stabbr", "year", "revtype")) %>%
  select(stabbr, scenario, year, 
         stgdp, stgdp_pch, 
         usgdp, usgdp_pch, 
         capgains, capgains_lag, capgains_pch,
         revtype, rev, rev_pch,
         econfc, equityfc, govtfc)
base
summary(base)
count(base, stabbr)
count(base, stabbr, scenario, econfc, equityfc, govtfc)
count(base, revtype)

```


```{r assume2021}
# use state gdp to fill in nontax growth rates
assume2021 <- assume %>%
  filter(year==2021) %>%
  right_join(scenarios, by = c("stabbr", "govtfc")) %>%  # note the right join
  left_join(stusgdp %>% 
              filter(year==2021) %>%
              select(stabbr, year, econfc=forecast, gdppch=pch), 
            by = c("stabbr", "year", "econfc")) %>%
  mutate(nontax=ifelse(is.na(nontax), gdppch, nontax)) %>%
  select(-gdppch, -type)
assume2021

assume2021_long <-
  assume2021 %>%
  pivot_longer(cols=c(iit, cit, gst, othertax, nontax), names_to = "revtype", values_to = "pch2021")

```


```{r fc_2021}
# fill in 2021 values using assume2021

fcast <- base %>%
  left_join(assume2021_long %>%
              select(-scenario),
            by=c("year", "stabbr", "revtype", "govtfc", "econfc", "equityfc")) %>%
  group_by(stabbr, scenario, econfc, equityfc, govtfc, revtype) %>%
  mutate(rev=ifelse(year==2021 & is.na(rev),
                    rev[year==2020] * (1 + pch2021 / 100),
                    rev),
         rev_pch=rev / rev[match(year - 1, year)] * 100 - 100) %>%
  select(-pch2021) %>%
  ungroup
# glimpse(fcast)
# fcast %>% filter(year %in% 2020:2021, stabbr=="MA")


```


```{r fc_interim}
# estimate through 2021 then fc 2022-2024

# create the right tsibble
fcast_ts <- fcast %>%
  select(-rev_pch) %>%
  filter(year >= 1996) %>% # we don't have capgains_lag before here
  mutate(stgdp_b=stgdp / 1e3) %>%
  as_tsibble(index=year, key = c(stabbr, econfc, equityfc, govtfc, revtype))

revmods <- fcast_ts %>%
  filter(year <= 2021) %>%
  model(modcg = ARIMA(rev ~ stgdp_b + capgains_lag),
        modbase = ARIMA(rev ~ stgdp_b))
saveRDS(revmods, here::here("data", "revmods.rds"))


revmods <- readRDS(here::here("data", "revmods.rds"))
# forecast
interim <- revmods %>%
  forecast(new_data=fcast_ts %>% filter(year %in% 2022:2024))

interim_keep <- interim %>%
  mutate(iitmod = (revtype=="iit") & (.model=="modcg"),
         othermod=(revtype != "iit") & (.model=="modbase")) %>%
  filter(iitmod | othermod) %>%
  as_tibble

# add the forecasts in to the base file
fcast2 <- fcast %>%
  left_join(interim_keep %>%
              select(stabbr, year, econfc, equityfc, govtfc, revtype, revfc=.mean),
            by = c("stabbr", "year", "econfc", "equityfc", "govtfc", "revtype")) %>%
  mutate(rev=ifelse(year >= 2022, revfc, rev)) %>%
  # override the model forecast for nontax revenue
  group_by(stabbr, econfc, equityfc, govtfc, revtype) %>%
  mutate(rev=ifelse(year %in% 2022:2024 & revtype=="nontax",
                    stgdp / stgdp[year==2021] * rev[year==2021],
                    rev)) %>%
  ungroup
           

rt <- "iit"
rt <- "gst"
rt <- "cit"
rt <- "othertax"
rt <- "nontax"
fcast2 %>%
  filter(stabbr=="NJ", revtype==rt) %>%
  filter(year %in% 2015:2025) %>%
  ggplot(aes(year, rev, colour=scenario)) +
  geom_line() +
  geom_point() +
  ggtitle(rt)


scen <- "baseline"
fcast2 %>%
  filter(stabbr=="NJ", scenario=="baseline") %>%
  filter(year %in% 2015:2025) %>%
  ggplot(aes(year, rev * 1000 / stgdp * 100, colour=revtype)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks=seq(2010, 2030, 2)) +
  ggtitle(scen)

fcast2 %>%
  filter(stabbr=="NJ", scenario=="baseline") %>%
  filter(year %in% 2015:2025) %>%
  group_by(year) %>%
  summarise(osr=sum(rev), stgdp=mean(stgdp)) %>%
  ungroup %>%
  ggplot(aes(year, osr * 1000 / stgdp * 100)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks=seq(2010, 2030, 2)) +
  ggtitle(scen)

```


```{r fc_longterm}
fcast2
fcast3 <- fcast2 %>%
  group_by(stabbr, econfc, equityfc, govtfc, revtype) %>%
  arrange(year) %>%
  mutate(irev=ifelse(year <= 2024, 1, 1 + stgdp_pch / 100),
         cprod=cumprod(irev),
         rev=ifelse(year > 2024,
                    rev[year==2024] * cprod,
                    rev)) %>%
  ungroup

fcast3 %>%
  filter(stabbr=="MA", revtype=="iit", year>=2020) %>%
  select(stabbr, year, econfc, equityfc, govtfc, revtype, stgdp_pch, irev, cprod)

rt <- "iit"
rt <- "gst"
rt <- "cit"
rt <- "othertax"
rt <- "nontax"
fcast3 %>%
  filter(stabbr=="NJ", revtype==rt) %>%
  filter(year >= 2015) %>%
  ggplot(aes(year, rev, colour=scenario)) +
  geom_line() +
  geom_point() +
  ggtitle(rt)

```


```{r fc_wide}
fcast_wide <- fcast3 %>%
  select(-c(rev_pch, revfc, irev, cprod)) %>%
  pivot_wider(names_from = revtype, values_from = rev) %>%
  mutate(tottax=naz(iit) + naz(gst) + naz(cit) + naz(othertax),
         osr=tottax + naz(nontax))
  
fcast_wide %>%
  filter(stabbr=="NJ") %>%
  filter(year >= 2015) %>%
  ggplot(aes(year, osr, colour=scenario)) +
  geom_line() +
  geom_point() +
  ggtitle("osr")

fcast_wide %>%
  filter(stabbr=="NJ") %>%
  filter(year >= 2010) %>%
  mutate(pct=osr * 1000 / stgdp * 100) %>%
  ggplot(aes(year, pct, colour=scenario)) +
  geom_line() +
  geom_point() +
  ggtitle("pct")

fcast_wide %>%
  pivot_longer(cols=c(iit, gst, cit, othertax, tottax, nontax, osr),
               names_to = "revtype",
               values_to = "rev") %>%
  mutate(pctgdp=rev * 1000 / stgdp * 100) %>%
  filter(stabbr=="NJ", year >= 2015, scenario=="baseline") %>%
  ggplot(aes(year, pctgdp, colour=revtype)) +
  geom_line() +
  geom_point() +
  ggtitle("pctgdp")

```




```{r state_gdp_functions}
# functions to be applied to each state
gdp_diff <- function(st){
    # compare national and state gdp growth for a state
  df <- stusgdp %>%
    filter(stabbr %in% c("US", st),
           forecast=="moodys_dec2020",
           year >= 1965) %>%
    select(year, stabbr, pch) %>%
    pivot_wider(names_from = stabbr, values_from = pch) %>%
    mutate(diff=.[[st]] - US)
  df
}

gdp_comp_plot <- function(st){
  # compare national and state gdp growth for a state
  df <- gdp_diff(st)
  
  df %>%
    select(-diff) %>%
    filter(year >= 2000, year <= 2030) %>%
    pivot_longer(-year, names_to = "stabbr") %>%
    ggplot(aes(year, value, colour=stabbr)) +
      geom_line(size=1) +
      geom_point() +
      scale_colour_manual(values=c("blue", "darkgreen")) +
      geom_hline(yintercept = 0) +
      geom_vline(xintercept = 2020.5, linetype="dotted") +
      # geom_hline(aes(yintercept=avg$avg), colour="red", size=0.4) +
      scale_y_continuous(name="% change", breaks=seq(-20, 20, 1)) +
      scale_x_continuous(name="State fiscal year", breaks=seq(1980, 2050, 5)) +
      ggtitle(paste0("Nominal GDP growth for ", st, " and the nation, Moody's December 2020 forecast"),
              subtitle=paste0("Dotted vertical line marks break between history and forecast")) +
      theme_bw()
}


gdp_diff_plot <- function(st){
  # compare national and state gdp growth for a state
  df <- gdp_diff(st)
  
  avgstart <- 2000
  avgend <- 2020
  avg <- df %>%
    filter(year %in% avgstart:avgend) %>%
    summarise(avg=mean(diff))
  
  df %>%
    filter(year >= 2000, year <= 2030) %>%
    ggplot(aes(year, diff)) +
      geom_line(colour="blue", size=1) +
      geom_point(colour="blue") +
      geom_hline(yintercept = 0) +
      geom_vline(xintercept = 2020.5, linetype="dotted") +
      geom_hline(aes(yintercept=avg$avg), colour="red", size=0.4) +
      scale_y_continuous(name="State % change minus US % change", breaks=seq(-10, 10, 1)) +
      scale_x_continuous(name="State fiscal year", breaks=seq(1980, 2050, 5)) +
      ggtitle(paste0("Nominal GDP growth: ", st, " minus nation, Moody's December 2020 forecast"),
              subtitle=paste0("Red horizontal line is average over ", avgstart, "-", avgend,
                              ". Dotted vertical line marks break between history and forecast.")) +
      theme_bw()
  # df
}


```


```{r revenue_functions}

gdp_osr_plot <- function(st){
  recuse <- recessions %>%
    filter(rec_year > 1978)

  p <- gdposr_pch %>%
    filter(stabbr==st, year >=1978) %>%
    ggplot(aes(year, pch, colour=name)) +
      geom_line(size=1) +
      geom_point() +
      scale_colour_manual(values=c("blue", "darkgreen")) +
      geom_hline(yintercept = 0) +
      annotate("rect",
             fill = "lightgrey",
             alpha = 0.5, # larger alpha is darker rectangle
             xmin = recuse$peak_decimal, xmax = recuse$trough_decimal,
             ymin = -Inf, ymax = Inf) +
      scale_x_continuous(name=NULL, breaks=seq(1960, 2030, 5)) +
      scale_y_continuous(name="% change vs. year ago", breaks=seq(-50, 50, 2)) +
      theme_bw() +
      theme(legend.title = element_blank())
  p
}

iit_gdpcg_plot <- function(st){
  stname <- stname(st)
  
  recuse <- recessions %>%
    filter(rec_year > 1995)
    
  p <- iit_gdpcg %>%
    filter(stabbr==st, year >= 1996, name != "capgains") %>%
    ggplot(aes(year, pch, colour=name)) +
      geom_line(size=1) +
      geom_point() +
      scale_colour_manual(values=c("blue", "darkgreen", "red")) +
      geom_hline(yintercept = 0) +
      annotate("rect",
             fill = "lightgrey",
             alpha = 0.5, # larger alpha is darker rectangle
             xmin = recuse$peak_decimal, xmax = recuse$trough_decimal,
             ymin = -Inf, ymax = Inf) +
      scale_x_continuous(name=NULL, breaks=seq(1960, 2030, 5)) +
      scale_y_continuous(name="% change vs. year ago", breaks=seq(-100, 100, 5)) +
      ggtitle(paste0(stname, ": % change in state income tax, state GDP, and lagged national capital gains")) +
      theme_bw() +
      theme(legend.title = element_blank())
  p
}


```


```{r forecast_reporting_functions}
# fcast_wide %>%
#   pivot_longer(cols=c(iit, gst, cit, othertax, tottax, nontax, osr),
#                names_to = "revtype",
#                values_to = "rev") %>%
#   mutate(pctgdp=rev * 1000 / stgdp * 100) %>%
#   filter(stabbr=="NJ", year >= 2015, scenario=="baseline") %>%
#   ggplot(aes(year, pctgdp, colour=revtype)) +
#   geom_line() +
#   geom_point() +
#   ggtitle("pctgdp")

osr_scen <- function(st){
  p <- fcast_wide %>%
    filter(stabbr==st, year >= 2015) %>%
  ggplot(aes(year, osr, colour=scenario)) +
  geom_line() +
  geom_point() +
  ggtitle("Scenarios") +
  theme_bw()
  
  p
}

# st <- "NJ"
# scenario <- "baseline"

osr_bkdwn <- function(st, scenario){
  if(st != "NJ" & scenario != "baseline"){
      print(paste0(scenario, " not yet available"))
      return()
    }
  
  stname <- stname(st)
  vars <- c("iit", "gst", "cit", "othertax", "tottax", "nontax", "osr")
  
  data <- fcast_wide %>%
    filter(stabbr==st, scenario==!!scenario, year >= 2018) %>%
    select(stabbr, year, all_of(vars)) %>%
    mutate(across(all_of(vars), ~ . * 1e3))
    
  
  tab <- data %>%
  gt() %>%  
  tab_header(
      title = paste0(stname, " own-source revenue, $ millions"),
      subtitle = paste0("Scenario: ", scenario)
    ) %>%
    cols_label(
      year=html("State fiscal year<br>ending in:")
    ) %>%
    fmt_currency(
      columns = vars,
      rows=1,
      decimals = 0,
      scale_by = 1,
      suffixing = FALSE
    ) %>%
    fmt_number(
      columns = vars,
      rows=2:nrow(data),
      decimals = 0,
      scale_by = 1,
      suffixing = FALSE
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = "#f7f7f7")
      ),
      locations = cells_body(
        rows = seq(1, nrow(data), 2)
        )
    ) %>%
    tab_source_note("OSR categories use Census-definitions")
  
  tab
}


osr_pch <- function(st, scenario){
  if(st != "NJ" & scenario != "baseline"){
      print(paste0(scenario, " not yet available"))
      return()
    }
  
  stname <- stname(st)
  vars <- c("iit", "gst", "cit", "othertax", "tottax", "nontax", "osr")
  
  data <- fcast_wide %>%
    filter(stabbr==st, scenario==!!scenario, year >= 2017) %>%
    select(stabbr, year, all_of(vars)) %>%
    mutate(across(all_of(vars), ~ . / .[match(year - 1, year)] * 100 - 100))

  tab <- data %>%
    gt() %>%  
    tab_header(
      title = paste0(stname, " own-source revenue, % change"),
      subtitle = paste0("Scenario: ", scenario)
      ) %>%
      cols_label(
        year=html("State fiscal year<br>ending in:")
      ) %>%
      fmt_percent(
        columns = vars,
        # rows=1:nrow(data),
        decimals = 1,
        scale_values = FALSE
      ) %>%
      tab_style(
        style = list(
          cell_fill(color = "#f7f7f7")
        ),
        locations = cells_body(
          rows = seq(1, nrow(data), 2)
          )
      ) %>%
      tab_source_note("OSR categories use Census-definitions")
  
  tab
}


```



```{r report_function}
# define the functions we want to call, including titles
# workaround https://github.com/rstudio/rstudio/issues/1795#issuecomment-505779701
#   use plot.new(), dev.off()
#  cat('\n\n<!-- -->\n\n') may be needed if there are problems

state_report <- function(st){
  stname <- stname(st)
  
  cat("\n")
  cat("## ", stname, "Report\n")
  
  cat("\n")
  cat("### Descriptive analysis \n")

  # The economy
  cat("\n")
  cat("#### GDP growth for ", stname, "and the US", "\n")
  print(gdp_comp_plot(st))
  plot.new()
  dev.off()
  
  cat("\n")
  cat("#### ", stname, " GDP growth minus United States GDP growth \n")
  print(gdp_diff_plot(st))
  plot.new()
  dev.off()
  cat('\n\n')
  
  cat("\n")
  cat("#### History: ", stname, " state GDP growth and own-source revenue growth \n")
  print(gdp_osr_plot(st))
  plot.new()
  dev.off()
  cat('\n\n')
  
  cat("\n")
  cat("#### History: ", stname, " state income tax, state GDP growth, and lagged national capital gains\n")
  print(iit_gdpcg_plot(st))
  plot.new()
  dev.off()
  cat('\n\n')
  
    
  cat("\n")
  cat("### Forecasts \n")
  
  # OSR forecasts
  cat("\n")
  cat("#### ", stname, " own-source revenue scenarios\n")
  print(osr_scen(st))
  plot.new()
  dev.off()
  cat('\n\n')
  
  # OSR forecast breakdown
  cat("\n")
  cat("#### ", stname, " own-source revenue breakdown - pre-Covid\n")
  print(osr_bkdwn(st, scenario="precovid"))
  plot.new()
  dev.off()
  # cat('\n\n')
  
  cat("\n")
  cat("#### ", stname, " own-source revenue breakdown - Covid baseline\n")
  print(osr_bkdwn(st, scenario="baseline"))
  plot.new()
  dev.off()
  # cat('\n\n')
  
  cat("\n")
  cat("#### ", stname, " own-source revenue breakdown - downside\n")
  print(osr_bkdwn(st, scenario="downside"))
  plot.new()
  dev.off()
  # cat('\n\n')
  
  cat("\n")
  cat("#### ", stname, " own-source revenue breakdown, % change - Covid baseline\n")
  print(osr_pch(st, scenario="baseline"))
  plot.new()
  dev.off()
  # cat('\n\n')
  
  cat("\n")
  cat("#### ", stname, " own-source revenue breakdown, % change - downside\n")
  print(osr_pch(st, scenario="downside"))
  plot.new()
  dev.off()
  # cat('\n\n')
  
}

```


```{r run_reports, include=TRUE, results='asis', message=FALSE, warning=FALSE}
# fig.keep='all', fig.show='asis'

state_report("MA")
state_report("NJ")
 

```




```{r nontax_analysis, eval=FALSE}
# history growth tax nontax gdp
# df <- stgdp %>%
#   filter(stabbr==st, src=="cbo_jul2020") %>%
#   mutate(name="gdp") %>%
#   bind_rows(osr %>% filter(stabbr==st, name %in% c("tottax", "nontax"))) %>%
#   filter(year %in% 1990:2018) %>%
#   group_by(name) %>%
#   mutate(pch=value / value[match(year - 1, year)] * 100 - 100) %>%
#   ungroup %>%
#   select(-src, -value)

# does a simple regression tell us whether nontax is more closely associated with gdp or tottax? NO
# dfw <- df %>%
#   pivot_wider(values_from = pch)
# summary(lm(nontax ~ tottax, data=dfw))
# summary(lm(nontax ~ gdp, data=dfw))  # coeff on gdp clearly not signif diff from 1
# 
# 
# summary(lm(nontax ~ tottax, data=dfw %>% filter(!year %in% c(1992, 2003, 2004))))
# summary(lm(nontax ~ gdp, data=dfw %>% filter(!year %in% c(1992, 2003, 2004))))

# df %>%
#   ggplot(aes(year, pch, colour=name)) +
#   geom_line() +
#   geom_point() +
#   scale_x_continuous(breaks=seq(1990, 2020, 5)) +
#   scale_y_continuous(breaks=seq(-40, 50, 5)) +
#   geom_hline(yintercept = 0)


```



