---
title: "Own-source revenue for pension stress tests"
author: "Don Boyd"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook:
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: true
      smooth_scroll: false
  html_document:
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: true
      smooth_scroll: false      
editor_options:
  chunk_output_type: inline
---


```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE, fig.width=10, fig.height=6)
options(width = 150)
```


```{r libraries, include=FALSE}
source(here::here("include", "libraries.r"))
devtools::session_info()
```


```{r globals}

  # html_document:
  #   toc: yes
  #   toc_depth: 5
  #   toc_float:
  #     collapsed: false
  #     smooth_scroll: false
  #   df_print: paged
```


```{r define_scenarios}
# define scenarios as combinations of:

#   states & state govt forecasts

#   national forecasts
    # cbo_precovid
    # cbo_jul2020
    # fedalt
    # moodys_jul2020p50
    # moodys_jul2020p90
    # moodys_dec2020

#   equity forecasts
#     pew_covidbase
#     pew_fedalt

scenarios <- tribble(
  ~stabbr, ~govtfc, ~econfc, ~equityfc, ~scenario,
  
  "NJ", "ols_sep2020", "moodys_dec2020", "pew_covidbase",  "baseline",
  "NJ", "gov_aug2020", "fedalt", "pew_fedalt", "downside",
  "NJ", "gov_bmxleg", "cbo_precovid", "pew_covidbase", "precovid",
  
  "MA", "gov_oct2020", "moodys_dec2020", "pew_covidbase",  "baseline",
  "MA", "gov_oct2020", "fedalt", "pew_fedalt",  "downside",
  "MA", "consensus_jan2020", "cbo_precovid", "pew_covidbase",  "precovid",
)
# gov_oct2020

# define states we are looking at, based on the scenarios
# sts <- unique(scenarios$stabbr)


```

```{r define_forecast_parameters}

trough_year <- 2021

mod_recovery_years <- 2022:2025   # period for model forecasts
gap_recovery_years <- 2022:2026  # period for gap-closing forecasts, may not be same as mod_recovery_years

```


<!--
Note:

-->


**See explanations AFTER the graphs and tables below, in the *Goals and methods section*.**


# Preliminaries

```{r functions}
pch <- function(df){
  df2 <- df %>%
    mutate(pch=value / value[match(year - 1, year)] * 100 - 100)
  df2$pch
}

stname <- function(stabbr){
  state.name[state.abb == stabbr]
}

```


```{r get_data}
# get data
usgdp <- readRDS(here::here("data", "usgdp.rds"))  # $ millions
stgdp <- readRDS(here::here("data", "stgdp.rds"))  # $ millions

sp500tr3 <- readRDS(here::here("data", "sp500tr.rds"))
cg <- readRDS(here::here("data", "uscapgains.rds"))
cgmodel <- readRDS(here::here("data", "cgmodel.rds"))
cgfcast <- readRDS(here::here("data", "cgfcast.rds"))

osr <- readRDS(here::here("data", "osr_census_updated.rds")) %>% # ends 2020
  mutate(value=value)  %>% 
  arrange(stabbr, name, year) %>%
  group_by(stabbr, name) %>%
  mutate(pch=value / value[match(year - 1, year)] * 100 - 100) %>%
  ungroup
summary(osr)  # $ millions


osr_pctgdp <- readRDS(here::here("data", "osr_pctgdp.rds"))

targets <- osr_pctgdp %>%
  pivot_longer(cols=starts_with("p"), values_to = "longrun_targetpct", names_to = "ma_years") %>%
  mutate(ma_years=str_sub(ma_years, 2, -1) %>% as.integer)
# targets

```



```{r get_assumptions, include=FALSE}
fn <- "assumptions.xlsx"

assume <- read_excel(here::here("data", fn), sheet="osr_forecasts") %>%
  filter(!is.na(stabbr)) %>%
  # convert to percentage
  mutate(across(c(iit, cit, gst, othertax, nontax), ~ . * 100))
assume

```


## National economic forecasts

The plots below show:

*   All available nominal GDP forecasts
*   Pre-Covid forecasts: CBO early 2020 (January?) and Moody's December 2019
*   Moody's baseline forecasts and how they have changed over time (December 2019, July 2020, December 2020)
*   Downside Covid forecasts (Moody's July 2020 p90 severe stress scenario, and the Federal reserve alternative fedalt forecast)

The forecasts are on a July-June state fiscal year basis. (Each year ends in June. For example, the 2021 forecast is for the 12 months ending in June 2021.)


```{r}
plot_fc <- function(fcorder, titlepre){
  usgdp %>%
    select(year, all_of(fcorder)) %>%
    filter(year >= 2015) %>%
    pivot_longer(-year, names_to = "forecast") %>%
    mutate(forecast=factor(forecast, level=fcorder)) %>%
    arrange(forecast) %>%
    ggplot(aes(year, value / 1e3, colour=forecast)) +
    geom_line(size=1) +
    geom_point() +
    scale_y_continuous(name="$ billions", breaks=seq(10e3, 50e3, 2.5e3), labels=scales::comma) +
    scale_x_continuous(name="State fiscal year", breaks=seq(2010, 2040, 2)) +
    ggtitle(paste0(titlepre, " national forecasts of nominal GDP, state fiscal year basis")) +
    theme_bw()
}

```


### All available national forecasts
```{r include=TRUE, fig.width=10, fig.height=6}

fcorder <- c("cbo_precovid", "moodys_dec2019", "cbo_jul2020", "moodys_jul2020p50",
             "moodys_dec2020", "moodys_jul2020p90", "fedalt")
plot_fc(fcorder, "All")

```


### Pre-Covid national forecasts
```{r include=TRUE, fig.width=10, fig.height=6}

fcorder <- c("cbo_precovid", "moodys_dec2019")
plot_fc(fcorder, "Pre-Covid") +
  scale_colour_manual(values=c("blue", "darkgreen"))

```


### Moody's baseline (i.e., considered most likely) national forecasts
```{r include=TRUE, fig.width=10, fig.height=6}

fcorder <- c("moodys_dec2019", "moodys_jul2020p50", "moodys_dec2020")
plot_fc(fcorder, "Moody's baseline")

```



### Downside Covid national forecasts
```{r include=TRUE, fig.width=10, fig.height=6}

fcorder <- c("moodys_jul2020p90", "fedalt")
plot_fc(fcorder, "Downside Covid") +
  scale_colour_manual(values=c("blue", "darkgreen"))

```


## National forecasts: Stock market and capital gains

Capital gains are important to state income taxes, as will be apparent when we look at individual states.

We have a small model that estimates and forecasts national capital gains based upon national GDP, the stock market (S&P 500 total returns), and capital gains' own history. (A regression with ARIMA errors model.)

Here are fit statistics from the model:


```{r include=TRUE}
report(cgmodel)
```

Here is a plot of how well/poorly the model does over history. It captures broad trends but is not very accurate, as is generally true of capital gains models: capital gains are highly volatile and difficult to predict.

```{r cgfit, include=TRUE, fig.width=10, fig.height=6}

cgmodel %>% 
  augment() %>%
  select(year, actual=cg, fitted=.fitted) %>%
  pivot_longer(-year, names_to = "type") %>%
  ggplot(aes(year, value, colour=type)) +
  geom_line(size=1) +
  geom_point() +
  scale_colour_manual(values=c("blue", "darkgreen")) +
  scale_x_continuous(name="Calendar year", breaks=seq(1990, 2020, 2)) +
  scale_y_continuous(name="$ billions", labels = scales::comma) +
  ggtitle("Model fit for national capital gains model") +
  theme_bw()

```

We used this model to forecast capital gains under different economic forecasts, using the baseline and fedalt equity return assumptions. Here are the forecasts under selected economic forecast and equity-return assumption combinations.

The combination of the fedalt economic scenario plus the fedalt equity-return assumptions results in large capital gains reductions and will have large impacts on state personal income tax forecasts.


```{r cgfc, include=TRUE, fig.width=10, fig.height=6}

cgfcast %>%
  filter(year >= 2015) %>%
  filter((gdpname=="cbo_precovid" & eqname=="pew_covidbase") |
         (gdpname=="cbo_jul2020" & eqname=="pew_covidbase") |
         (gdpname=="moodys_dec2020" & eqname=="pew_covidbase") |
         (gdpname=="fedalt" & eqname=="pew_covidbase") |
         (gdpname=="fedalt" & eqname=="pew_fedalt")) %>%
  mutate(grp=paste0(gdpname, "-", eqname)) %>%
  ggplot(aes(year, cgfcast, colour=grp)) +
  geom_line(size=1) +
  geom_point() +
  scale_x_continuous(name=NULL, breaks=seq(1990, 2040, 2)) +
  scale_y_continuous(name="$ billions", labels = scales::comma) +
  ggtitle("Model forecasts of capital gains",
          subtitle="Selected economic-equity forecast combinations") +
  theme_bw()


```


## Revenue forecasting scenarios

A revenue forecasting scenario is a combination of three sets of assumptions:

1.    **National economic forecast:**  Drives the state economic forecast. Currently we have two main forecasts:
      +   Pre-Covid forecast -- currently the CBO pre-Covid forecast provided by Pew
      +   Covid baseline economic forecast -- currently the Moody's December 2020 forecast provided by Pew; this can be updated to the CBO February 2021 forecast when available
    +   Covid downside forecast -- currently the fedalt forecast provided by Pew


2.    **Equity returns (domestic equity) forecast:**  Together with national GDP this drives the national capital gains forecast:
      +   Baseline scenario provided by Pew
      +   Downside scenario provided by Pew (based on fedalt scenario)


3.    **Near-term state revenue results (fiscal 2021):**
      +   Varies by state but generally will be the most-recent credible governmental forecast.
      +   It is possible to have multiple options for each state but currently I use only one.
      +   Where available, I also have a pre-Covid estimate for 2021. 
      +   I always use estimated actuals for 2020, which means we never have a "pure" pre-Covid baseline because 2020 estimated actuals reflect substantial Covid-related impacts for some revenue sources.
      
<br>
I combine these three sets of assumptions to construct up to three scenarios for each state:

1.    **Pre-covid - combines:**
      +   CBO pre-covid economic forecast
      +   Pew Covid baseline equity returns forecast
      +   A pre-covid 2021 revenue estimate if available

2.    **Covid baseline - combines:**
      +   Moody's December 2020 economic forecast
      +   Pew Covid baseline equity returns forecast
      +   Recent state government revenue estimate for 2021, reflecting Covid effects

3.    **Covid downside - combines:**
      +   Fed alternative economic forecast
      +   Pew Covid downside equity returns forecast
      +   Recent state government revenue estimate for 2021, reflecting Covid effects
      

## Revenue forecasting methods
Finally, I have two revenue forecast methods for each state.      
      


# State Own-Source Revenue analysis and forecasts

```{r state_data_prep}
# prep data for ALL states, then draw as needed for individual states

# state and US gdp, history and forecast, all economic forecasts, 1948-2030
stusgdp <- bind_rows(usgdp %>% mutate(stabbr="US"),
                     stgdp) %>%
  pivot_longer(-c(year, stabbr), names_to = "forecast") %>%
  group_by(forecast, stabbr) %>%
  mutate(pch=value / value[match(year - 1, year)] * 100 -100) %>%
  ungroup

# same, but wide (no rows for US), 1965-2030
stgdp_uswide <- stusgdp %>%
  group_by(forecast, year) %>%
  mutate(usgdp=value[stabbr=="US"],
         usgdp_pch=pch[stabbr=="US"]) %>%
  ungroup %>%
  filter(stabbr != "US", year >= 1965) %>%
  rename(stgdp=value, stgdp_pch=pch)

# cg history and forecast, economic and equity forecast combinations, 1995-2030
capgains <- cgfcast %>%
  select(year, gdpname, eqname, capgains=cgfcast) %>%
  group_by(gdpname, eqname) %>%
  mutate(capgains_lag=capgains[match(year - 1, year)],
         capgains_pch=capgains / capgains_lag * 100 - 100) %>%
  ungroup
count(capgains, gdpname, eqname)

# state gdp and osr pch, 1965-2020
gdposr_pch <- stgdp %>%
  select(stabbr, year, gdp=moodys_dec2020) %>%
  inner_join(osr %>% 
               filter(name=="osr") %>% 
               select(stabbr, year, osr=value),
             by = c("stabbr", "year")) %>%
  pivot_longer(cols=-c(year, stabbr)) %>%
  group_by(stabbr, name) %>%
  mutate(pch=value / value[match(year - 1, year)] * 100 - 100) %>%
  ungroup %>%
  filter(year > min(year))

# State GDP, capital gains, and income tax, 1995-2020, based on moodys_dec2020
# on expectation that it will give the best estimate of FY 2020 gdp
iit_gdpcg <- stgdp %>%
  select(year, stabbr, gdp=moodys_dec2020) %>%
  inner_join(osr %>% 
               filter(name=="iit") %>% 
               select(stabbr, year, iit=value),
             by = c("year", "stabbr")) %>%
  inner_join(cg %>% 
               select(year, capgains=cbo_jul2020) %>%
               mutate(cglagged=capgains[match(year -1, year)]),
             by="year") %>%
  pivot_longer(-c(year, stabbr)) %>%
  group_by(stabbr, name) %>%
  mutate(pch=value / value[match(year - 1, year)] * 100 - 100) %>%
  ungroup


```




```{r}
# construct dataframe that will hold forecasts
osrvars <- c("iit", "gst", "cit", "othertax", "nontax") # just the elements, not totals

# create a base data frame to hold forecasts - joins will grab only the states of interest
base <- scenarios %>%
  inner_join(stgdp_uswide %>% 
               rename(econfc=forecast),
             by = c("stabbr", "econfc")) %>%
  # create an indexed value we can use to get stgdp growth from any year to another year
  group_by(scenario, econfc, equityfc, govtfc) %>%
  mutate(istgdp=stgdp / stgdp[year==1965]) %>%
  ungroup %>%
  left_join(capgains %>% 
              rename(econfc=gdpname, equityfc=eqname),
            by = c("econfc", "equityfc", "year")) %>%
  full_join(tibble(revtype=osrvars), by=character()) %>%  # create a record for each revtype!
  left_join(osr %>% 
              filter(name %in% osrvars) %>% 
              rename(revtype=name, rev=value, rev_pch=pch),
            by = c("stabbr", "year", "revtype")) %>%
  select(stabbr, scenario, year, 
         stgdp, stgdp_pch, 
         usgdp, usgdp_pch, istgdp,
         capgains, capgains_lag, capgains_pch,
         revtype, rev, rev_pch,
         econfc, equityfc, govtfc)
base
summary(base)
count(base, stabbr)
count(base, stabbr, scenario, econfc, equityfc, govtfc)
count(base, revtype)

```


```{r assume2021}
# use state gdp to fill in nontax growth rates
assume2021 <- assume %>%
  filter(year==2021) %>%
  right_join(scenarios, by = c("stabbr", "govtfc")) %>%  # note the right join
  left_join(stusgdp %>% 
              filter(year==2021) %>%
              select(stabbr, year, econfc=forecast, gdppch=pch), 
            by = c("stabbr", "year", "econfc")) %>%
  mutate(nontax=ifelse(is.na(nontax), gdppch, nontax)) %>%
  select(-gdppch)
assume2021

assume2021_long <-
  assume2021 %>%
  pivot_longer(cols=c(iit, cit, gst, othertax, nontax), names_to = "revtype", values_to = "pch2021")

```



```{r fc_2021}
# fill in 2021 values using assume2021 growth rates

fcast <- base %>%
  left_join(assume2021_long %>%
              select(-scenario),
            by=c("year", "stabbr", "revtype", "govtfc", "econfc", "equityfc")) %>%
  group_by(stabbr, scenario, econfc, equityfc, govtfc, revtype) %>%
  mutate(rev=ifelse(year==2021 & is.na(rev),
                    rev[year==2020] * (1 + pch2021 / 100),
                    rev),
         rev_pch=rev / rev[match(year - 1, year)] * 100 - 100) %>%
  select(-pch2021) %>%
  ungroup
# glimpse(fcast)
# fcast %>% filter(year %in% 2020:2021, stabbr=="MA")


```


```{r}
# create a tsibble for model-based forecasts
fcast_ts <- fcast %>%
  select(-rev_pch) %>%
  filter(year >= 1996) %>% # we don't have capgains_lag before here
  mutate(stgdp_b=stgdp / 1e3) %>%  # put stgdp in billions to reduce numerical issues
  as_tsibble(index=year, key = c(stabbr, econfc, equityfc, govtfc, revtype))

```


```{r fc_fitsave_recovery_model}
# estimate two simple regression with ARIMA errors models
#   gdp and capital gains, which we will use only for the income tax
#   gdp only, which we will use for other tax sources
a <- proc.time()
revmods <- fcast_ts %>%
  filter(year <= 2021) %>%
  model(modcg = ARIMA(rev ~ stgdp_b + capgains_lag),
        modbase = ARIMA(rev ~ stgdp_b))
b <- proc.time()
b - a  # takes about 7 seconds to estimate, so save
saveRDS(revmods, here::here("data", "revmods.rds"))

```


```{r fc_forecast_recovery_models}
# forecast taxes in the recovery period using models
# create fcast_mod with recovery years only

revmods <- readRDS(here::here("data", "revmods.rds"))
# forecast
recovery_modfc <- revmods %>%
  forecast(new_data=fcast_ts %>% filter(year %in% mod_recovery_years))

fcast_mod <- recovery_modfc %>%
  as_tibble() %>%
  mutate(iitmod = (revtype=="iit") & (.model=="modcg"),
         othermod=(revtype != "iit") & (.model=="modbase")) %>%
  filter(iitmod | othermod) %>%
  select(stabbr, year, scenario, econfc, equityfc, govtfc, revtype, fcmod=.mean)
summary(fcast_mod)  # only includes the recovery years

fcast_mod %>% 
  filter(stabbr=="NJ", year %in% 2019:2025, scenario %in% c("baseline", "downside"))


```



```{r fc_forecast_recovery_gapclose}
# forecast using the gap-closing method
# create fcast_gap with recovery years only
targets

fcast_gap <- fcast %>%
  group_by(stabbr, scenario, revtype) %>%
  mutate(revgdp=rev / stgdp * 100,
         troughpct=revgdp[year==trough_year]) %>%
  filter(year %in% gap_recovery_years) %>%
  left_join(targets %>% 
              filter(ma_years==1, year==2019) %>%
              select(stabbr, revtype=name, longrun_targetpct),
            by=c("stabbr", "revtype")) %>%
  mutate(troughgap=troughpct - longrun_targetpct,
         year_targetpct=troughpct - troughgap * (year - trough_year) / length(gap_recovery_years),
         fcgap=stgdp * year_targetpct / 100) %>%
  ungroup
summary(fcast_gap)
glimpse(fcast_gap)

fcast_gap %>%
  filter(stabbr=="NJ", year <=2026) %>%
  select(stabbr, scenario, year, revtype, stgdp, rev, revgdp, 
         troughpct, longrun_targetpct, troughgap, year_targetpct, fcgap) %>%
  arrange(stabbr, scenario, revtype, year)

fcast_gap %>%
  filter(stabbr=="NJ", year <=2026) %>%
  select(stabbr, scenario, year, revtype, stgdp, troughpct, longrun_targetpct,
         troughgap, year_targetpct, fcgap) %>%
  arrange(stabbr, scenario, revtype, year)
  


```


```{r fc_longterm}
summary(fcast_mod)
summary(fcast_gap)

mainvars <- c("stabbr", "year", "econfc", "equityfc", "govtfc", "revtype")

fcast2 <- fcast %>%
  left_join(fcast_mod %>% select(all_of(c(mainvars, "fcmod"))),
            by = c("stabbr", "year", "revtype", "econfc", "equityfc", "govtfc")) %>%
  left_join(fcast_gap %>% select(all_of(c(mainvars, "fcgap"))),
            by = c("stabbr", "year", "revtype", "econfc", "equityfc", "govtfc")) %>%
  # fill in history
  mutate(across(c(fcmod, fcgap), ~ ifelse(year <= 2021, rev, .))) %>%
  # 2022+ use pch for nontax, all years
  group_by(stabbr, econfc, equityfc, govtfc, revtype) %>%
  # forecast nontax, all years, by assuming it grows as state gdp grows
  mutate(across(c(fcmod, fcgap), ~ ifelse(year > 2021 & revtype=="nontax",
                                          rev[year==2021] * istgdp / istgdp[year==2021],
                                          .)),
         # use separate periods for fcmod and fcgap
         fcmod = ifelse(year > max(mod_recovery_years) & revtype!="nontax",
                        fcmod[year==max(mod_recovery_years)] * istgdp / istgdp[year==max(mod_recovery_years)],
                        fcmod),
         fcgap = ifelse(year > max(gap_recovery_years) & revtype!="nontax",
                        fcgap[year==max(gap_recovery_years)] * istgdp / istgdp[year==max(gap_recovery_years)],
                        fcgap)) %>%
  ungroup

# fcast2 %>% filter(stabbr=="NJ", year %in% 2020:2025) %>% select(year, rev, fcmod, fcgap)
fcast2 %>% 
  filter(stabbr=="NJ", year %in% 2020:2026, scenario=="baseline", revtype=="iit") %>% 
  select(year, revtype, stgdp_pch, istgdp, rev, fcmod, fcgap)
  
# long
names(fcast2)
fcast_long <- fcast2 %>%
  select(stabbr, year, scenario, 
         econfc, equityfc, govtfc,
         usgdp, usgdp_pch,
         stgdp, stgdp_pch,
         capgains, capgains_lag,
         capgains_pch,
         revtype, model=fcmod, gapclose=fcgap) %>%
  pivot_longer(c(model, gapclose), names_to = "method", values_to = "rev")


```


```{r fc_wide}
fcast_wide <- fcast_long %>%
  pivot_wider(names_from = revtype, values_from = rev) %>%
  mutate(tottax=naz(iit) + naz(gst) + naz(cit) + naz(othertax),
         osr=tottax + naz(nontax))
  
# fcast_wide %>%
#   filter(stabbr=="NJ", method=="model") %>%
#   filter(year >= 2015) %>%
#   ggplot(aes(year, osr, colour=scenario)) +
#   geom_line() +
#   geom_point() +
#   ggtitle("osr")
# 
# fcast_wide %>%
#   filter(stabbr=="NJ", method=="model") %>%
#   filter(year >= 2010) %>%
#   mutate(pct=osr / stgdp * 100) %>%
#   ggplot(aes(year, pct, colour=scenario)) +
#   geom_line() +
#   geom_point() +
#   ggtitle("pct")
# 
# fcast_wide %>%
#   filter(stabbr=="NJ", scenario=="precovid") %>%
#   filter(year >= 2010) %>%
#   mutate(pct=osr / stgdp * 100) %>%
#   ggplot(aes(year, pct, colour=method)) +
#   geom_line() +
#   geom_point() +
#   ggtitle("pct")
# 
# 
# fcast_wide %>%
#   pivot_longer(cols=c(iit, gst, cit, othertax, tottax, nontax, osr),
#                names_to = "revtype",
#                values_to = "rev") %>%
#   mutate(pctgdp=rev * 1000 / stgdp * 100) %>%
#   filter(stabbr=="NJ", year >= 2015, scenario=="baseline") %>%
#   ggplot(aes(year, pctgdp, colour=revtype)) +
#   geom_line() +
#   geom_point() +
#   ggtitle("pctgdp")

```




```{r state_gdp_functions}
# functions to be applied to each state
gdp_diff <- function(st){
    # compare national and state gdp growth for a state
  df <- stusgdp %>%
    filter(stabbr %in% c("US", st),
           forecast=="moodys_dec2020",
           year >= 1965) %>%
    select(year, stabbr, pch) %>%
    pivot_wider(names_from = stabbr, values_from = pch) %>%
    mutate(diff=.[[st]] - US)
  df
}

gdp_comp_plot <- function(st){
  # compare national and state gdp growth for a state
  startyear <- 1990
  
  df <- gdp_diff(st)
  
  recuse <- recessions %>%
    filter(rec_year >= startyear)
  
  df %>%
    select(-diff) %>%
    filter(year >= startyear, year <= 2030) %>%
    pivot_longer(-year, names_to = "stabbr") %>%
    ggplot(aes(year, value, colour=stabbr)) +
      geom_line(size=1) +
      geom_point() +
      scale_colour_manual(values=c("blue", "darkgreen")) +
      geom_hline(yintercept = 0) +
      geom_vline(xintercept = 2020.5, linetype="dotted", size=1) +
      # geom_hline(aes(yintercept=avg$avg), colour="red", size=0.4) +
      scale_y_continuous(name="% change", breaks=seq(-20, 20, 1)) +
      scale_x_continuous(name="State fiscal year", breaks=seq(1980, 2050, 5)) +
      annotate("rect",
         fill = "lightgrey",
         alpha = 0.5, # larger alpha is darker rectangle
         xmin = recuse$peak_decimal, xmax = recuse$trough_decimal,
         ymin = -Inf, ymax = Inf) +
      ggtitle(paste0("Nominal GDP growth for ", st, " and the nation, Moody's December 2020 forecast"),
              subtitle=paste0("Dotted vertical line marks break between history and forecast")) +
      theme_bw()
}


gdp_diff_plot <- function(st){
  # compare national and state gdp growth for a state
  df <- gdp_diff(st)
  
  startyear <- 1990
  recuse <- recessions %>%
    filter(rec_year >= startyear)
  
  avgstart <- 2000
  avgend <- 2020
  avg <- df %>%
    filter(year %in% avgstart:avgend) %>%
    summarise(avg=mean(diff))
  
  df %>%
    filter(year >= startyear, year <= 2030) %>%
    ggplot(aes(year, diff)) +
      geom_line(colour="blue", size=1) +
      geom_point(colour="blue") +
      geom_hline(yintercept = 0) +
      geom_vline(xintercept = 2020.5, linetype="dotted", size=1) +
      geom_hline(aes(yintercept=avg$avg), colour="red", size=0.4) +
      scale_y_continuous(name="State % change minus US % change", breaks=seq(-10, 10, 1)) +
      scale_x_continuous(name="State fiscal year", breaks=seq(1980, 2050, 5)) +
      annotate("rect",
         fill = "lightgrey",
         alpha = 0.5, # larger alpha is darker rectangle
         xmin = recuse$peak_decimal, xmax = recuse$trough_decimal,
         ymin = -Inf, ymax = Inf) +    
      ggtitle(paste0("Nominal GDP growth: ", st, " minus nation, Moody's December 2020 forecast"),
              subtitle=paste0("Red horizontal line is average over ", avgstart, "-", avgend,
                              ". Dotted vertical line marks break between history and forecast.")) +
      theme_bw()
  # df
}


```


```{r revenue_functions}

gdp_osr_plot <- function(st){
  recuse <- recessions %>%
    filter(rec_year > 1978)

  p <- gdposr_pch %>%
    filter(stabbr==st, year >=1978) %>%
    ggplot(aes(year, pch, colour=name)) +
      geom_line(size=1) +
      geom_point() +
      scale_colour_manual(values=c("blue", "darkgreen")) +
      geom_hline(yintercept = 0) +
      annotate("rect",
             fill = "lightgrey",
             alpha = 0.5, # larger alpha is darker rectangle
             xmin = recuse$peak_decimal, xmax = recuse$trough_decimal,
             ymin = -Inf, ymax = Inf) +
      scale_x_continuous(name=NULL, breaks=seq(1960, 2030, 5)) +
      scale_y_continuous(name="% change vs. year ago", breaks=seq(-50, 50, 2)) +
      theme_bw() +
      theme(legend.title = element_blank())
  p
}

iit_gdpcg_plot <- function(st){
  stname <- stname(st)
  
  recuse <- recessions %>%
    filter(rec_year > 1995)
    
  p <- iit_gdpcg %>%
    filter(stabbr==st, year >= 1996, name != "capgains") %>%
    ggplot(aes(year, pch, colour=name)) +
      geom_line(size=1) +
      geom_point() +
      scale_colour_manual(values=c("blue", "darkgreen", "red")) +
      geom_hline(yintercept = 0) +
      annotate("rect",
             fill = "lightgrey",
             alpha = 0.5, # larger alpha is darker rectangle
             xmin = recuse$peak_decimal, xmax = recuse$trough_decimal,
             ymin = -Inf, ymax = Inf) +
      scale_x_continuous(name=NULL, breaks=seq(1960, 2030, 5)) +
      scale_y_continuous(name="% change vs. year ago", breaks=seq(-100, 100, 5)) +
      ggtitle(paste0(stname, ": % change in state income tax, state GDP, and lagged national capital gains")) +
      theme_bw() +
      theme(legend.title = element_blank())
  p
}


```


```{r forecast_reporting_functions}
# fcast_wide %>%
#   pivot_longer(cols=c(iit, gst, cit, othertax, tottax, nontax, osr),
#                names_to = "revtype",
#                values_to = "rev") %>%
#   mutate(pctgdp=rev * 1000 / stgdp * 100) %>%
#   filter(stabbr=="NJ", year >= 2015, scenario=="baseline") %>%
#   ggplot(aes(year, pctgdp, colour=revtype)) +
#   geom_line() +
#   geom_point() +
#   ggtitle("pctgdp")

osr_scen <- function(st, method){
  p <- fcast_wide %>%
    filter(stabbr==st, year >= 2015, method==!!method) %>%
  ggplot(aes(year, osr, colour=scenario)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(name="State fiscal year", breaks=seq(2000, 2040, 2)) +
  scale_y_continuous(name="Own-source revenue, $ millions", labels = scales::comma) +
  ggtitle(paste0("Scenarios using method: ", method)) +
  theme_bw()
  
  p
}

osr_method <- function(st, scenario, var){
  # if(st != "NJ" & scenario != "baseline"){
  #     print(paste0(scenario, " not yet available"))
  #     return()
  #   }  
  
  p <- fcast_wide %>%
    filter(stabbr==st, year >= 2015, scenario==!!scenario) %>%
    select(year, pvar=!!var, method) %>%
  ggplot(aes(year, pvar, colour=method)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(name="State fiscal year", breaks=seq(2000, 2040, 2)) +
  scale_y_continuous(name="$ millions", labels = scales::comma) +
  ggtitle(paste0("Methods for forecasting ", var, " using scenario: ", scenario)) +
  theme_bw()
  
  p
}


osr_method_pctgdp <- function(st, scenario, var){
  # if(st != "NJ" & scenario != "baseline"){
  #     print(paste0(scenario, " not yet available"))
  #     return()
  #   }  
  
  p <- fcast_wide %>%
    filter(stabbr==st, year >= 2010, scenario==!!scenario) %>%
    select(year, pvar=!!var, method, stgdp) %>%
  ggplot(aes(year, pvar / stgdp * 100, colour=method)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(name="State fiscal year", breaks=seq(2000, 2040, 2)) +
  scale_y_continuous(name="% of state GDP") +
  ggtitle(paste0("Methods for forecasting ", var, " using scenario: ", scenario)) +
  theme_bw()
  
  p
}


# st <- "NJ"
# scenario <- "baseline"

osr_bkdwn <- function(st, scenario, method){
  # if(st != "NJ" & scenario != "baseline"){
  #     print(paste0(scenario, " not yet available"))
  #     return()
  #   }
  
  stname <- stname(st)
  vars <- c("iit", "gst", "cit", "othertax", "tottax", "nontax", "osr")
  
  data <- fcast_wide %>%
    filter(stabbr==st, scenario==!!scenario, method==!!method, year >= 2018) %>%
    select(stabbr, year, all_of(vars))
  
  tab <- data %>%
  gt() %>%  
  tab_header(
      title = paste0(stname, " own-source revenue, $ millions"),
      subtitle = paste0("Scenario: ", scenario, "  --  Method: ", method)
    ) %>%
    cols_label(
      year=html("State fiscal year<br>ending in:")
    ) %>%
    fmt_currency(
      columns = vars,
      rows=1,
      decimals = 0,
      scale_by = 1,
      suffixing = FALSE
    ) %>%
    fmt_number(
      columns = vars,
      rows=2:nrow(data),
      decimals = 0,
      scale_by = 1,
      suffixing = FALSE
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = "#f7f7f7")
      ),
      locations = cells_body(
        rows = seq(1, nrow(data), 2)
        )
    ) %>%
    tab_source_note("OSR categories use Census-definitions")
  
  tab
}


osr_pch <- function(st, scenario, method){
  # if(st != "NJ" & scenario != "baseline"){
  #     print(paste0(scenario, " not yet available"))
  #     return()
  #   }
  
  stname <- stname(st)
  vars <- c("iit", "gst", "cit", "othertax", "tottax", "nontax", "osr")
  
  data <- fcast_wide %>%
    filter(stabbr==st, scenario==!!scenario, method==!!method, year >= 2017) %>%
    select(stabbr, year, all_of(vars)) %>%
    mutate(across(all_of(vars), ~ . / .[match(year - 1, year)] * 100 - 100))

  tab <- data %>%
    gt() %>%  
    tab_header(
      title = paste0(stname, " own-source revenue, % change"),
      subtitle = paste0("Scenario: ", scenario, "  --  Method: ", method)
      ) %>%
      cols_label(
        year=html("State fiscal year<br>ending in:")
      ) %>%
      fmt_percent(
        columns = vars,
        # rows=1:nrow(data),
        decimals = 1,
        scale_values = FALSE
      ) %>%
      tab_style(
        style = list(
          cell_fill(color = "#f7f7f7")
        ),
        locations = cells_body(
          rows = seq(1, nrow(data), 2)
          )
      ) %>%
      tab_source_note("OSR categories use Census-definitions")
  
  tab
}


```



```{r report_function}
# define the functions we want to call, including titles
# workaround https://github.com/rstudio/rstudio/issues/1795#issuecomment-505779701
#   use plot.new(), dev.off()
#  cat('\n\n<!-- -->\n\n') may be needed if there are problems

state_report <- function(st){
  stname <- stname(st)
  
  # cat("\n")
  cat("## ", stname, " \n")
  
  cat("\n")
  cat("### ", stname, " History {.tabset} \n")

  # The economy
  cat("\n")
  cat("#### GDP growth versus US", "\n")
  print(gdp_comp_plot(st))
  plot.new()
  dev.off()
  
  cat("\n")
  cat("#### GDP growth minus United States GDP growth \n")
  print(gdp_diff_plot(st))
  plot.new()
  dev.off()
  cat('\n\n')
  
  cat("\n")
  cat("#### State GDP growth and own-source revenue growth \n")
  print(gdp_osr_plot(st))
  plot.new()
  dev.off()
  cat('\n\n')
  
  cat("\n")
  cat("#### State income tax, state GDP growth, and lagged national capital gains\n")
  print(iit_gdpcg_plot(st))
  plot.new()
  dev.off()
  cat('\n\n')
  
    
  cat("\n")
  cat("### ", stname, " Forecasts {.tabset}\n")
  
  # OSR forecasts
  cat("\n")
  cat("#### Own-source revenue scenarios\n")
  cat("##### Method: Simple model\n")
  print(osr_scen(st, method="model"))
  plot.new()
  dev.off()
  cat("##### Method: Close gap between revenue as % of state GDP, and 2019 value\n")
  print(osr_scen(st, method="gapclose"))
  plot.new()
  dev.off()
  
  cat("##### Methods comparison, $ millions, baseline scenario\n")
  print(osr_method(st, scenario="baseline", var="osr"))
  plot.new()
  dev.off()
  print(osr_method(st, scenario="baseline", var="iit"))
  plot.new()
  dev.off()
  print(osr_method(st, scenario="baseline", var="gst"))
  plot.new()
  dev.off()
  print(osr_method(st, scenario="baseline", var="cit"))
  plot.new()
  dev.off()
  print(osr_method(st, scenario="baseline", var="othertax"))
  plot.new()
  dev.off()
  
  
  cat("##### Methods comparison, $ millions, downside scenario\n")
  print(osr_method(st, scenario="downside", var="osr"))
  plot.new()
  dev.off()
  print(osr_method(st, scenario="downside", var="iit"))
  plot.new()
  dev.off()
  print(osr_method(st, scenario="downside", var="gst"))
  plot.new()
  dev.off()
  print(osr_method(st, scenario="downside", var="cit"))
  plot.new()
  dev.off()
  print(osr_method(st, scenario="downside", var="othertax"))
  plot.new()
  dev.off()  
  
  cat("##### Methods comparison, % of state GDP, baseline scenario\n")
  print(osr_method_pctgdp(st, scenario="baseline", var="osr"))
  plot.new()
  dev.off()
  print(osr_method_pctgdp(st, scenario="baseline", var="iit"))
  plot.new()
  dev.off()
  print(osr_method_pctgdp(st, scenario="baseline", var="gst"))
  plot.new()
  dev.off()
  print(osr_method_pctgdp(st, scenario="baseline", var="cit"))
  plot.new()
  dev.off()
  print(osr_method_pctgdp(st, scenario="baseline", var="othertax"))
  plot.new()
  dev.off()
  
  
  cat("##### Methods comparison, % of state GDP, downside scenario\n")
  print(osr_method_pctgdp(st, scenario="downside", var="osr"))
  plot.new()
  dev.off()
  print(osr_method_pctgdp(st, scenario="downside", var="iit"))
  plot.new()
  dev.off()
  print(osr_method_pctgdp(st, scenario="downside", var="gst"))
  plot.new()
  dev.off()
  print(osr_method_pctgdp(st, scenario="downside", var="cit"))
  plot.new()
  dev.off()
  print(osr_method_pctgdp(st, scenario="downside", var="othertax"))
  plot.new()
  dev.off()    

  
  cat('\n\n')
  
  # OSR forecast breakdown, alternative scenarios and methods
  cat("\n")
  cat("#### Own-source revenue breakdown - pre-Covid\n")
  print(osr_bkdwn(st, scenario="precovid", method="model"))
  plot.new()
  dev.off()
    print(osr_bkdwn(st, scenario="precovid", method="gapclose"))
  plot.new()
  dev.off()
  
  cat("\n")
  cat("#### Own-source revenue breakdown - Covid baseline\n")
  print(osr_bkdwn(st, scenario="baseline", method="model"))
  plot.new()
  dev.off()
  print(osr_bkdwn(st, scenario="baseline", method="gapclose"))
  plot.new()
  dev.off()
  
  cat("\n")
  cat("#### Own-source revenue breakdown - downside\n")
  print(osr_bkdwn(st, scenario="downside", method="model"))
  plot.new()
  dev.off()
  print(osr_bkdwn(st, scenario="downside", method="gapclose"))
  plot.new()
  dev.off()
  
  cat("\n")
  cat("#### Own-source revenue breakdown, % change - Covid baseline\n")
  print(osr_pch(st, scenario="baseline", method="model"))
  plot.new()
  dev.off()
  print(osr_pch(st, scenario="baseline", method="gapclose"))
  plot.new()
  dev.off()
  
  cat("\n")
  cat("#### Own-source revenue breakdown, % change - downside\n")
  print(osr_pch(st, scenario="downside", method="model"))
  plot.new()
  dev.off()
  print(osr_pch(st, scenario="downside", method="gapclose"))
  plot.new()
  dev.off()
  
}

```


```{r run_reports, include=TRUE, results='asis', message=FALSE, warning=FALSE}
# fig.keep='all', fig.show='asis'

state_report("MA")
state_report("NJ")

```



# Goals and methods

## Goals

Goal is to forecast state own-source revenue (osr) and components using a method that:

*   is compatible with a state's own short-term forecasts,
*   stabilizes in the longer term to grow at the rate of state gdp, and
*   can be applied to individual states with a minimal amount of digging for new information


Key forecast elements:

*   State own-source revenue and major components
    +   using Census definitions
    +   state fiscal years (periods ending in June)
    +   nominal
    +   $ millions
    +   2021 through 2030
    
*   National economic forecast - uses one of the relatively current forecasts provided by Pew:
    +   CBO July 2020 (baseline)
    +   Moody's December 2020, p50 (baseline) - the most-current full forecast we have
    +   Moody's July 2020, p50
    +   Moody's July 2020, p90 (S3 - severe stress scenario)
    +   (We also have available a Moody's December 2019 baseline forecast, not used)
    +   Federal Reserve alternative severe forecast
    
*   State economic forecast:

    +   available state GDP forecasts are Moody's baseline forecasts released in December 2019, July 2020, and December 2020, each of which also has an associated Moody's national forecast
    +   to get state GDP forecasts under different national scenarios, I assume the difference between a state's growth rate and the national growth rate is the same as it is in the most-recent Moody's forecast (December 2020)

*   Equity return forecasts - factor into capital gains forecasts, which in turn affect the income tax. There are two equity return forecasts (domestic equities)
    +   pew_baseline -- the Pew Covid baseline -- **Note that this is not consistent with the CBO July 2020 economic forecast**
    +   pew_fedalt
    
*   Capital gains forecasts

    +   From a simple model based upon national GDP, S&P 500, and capital gains history
    +   Forecast varies depending on which national GDP forecast is used and which equity forecast is used
  

Overall approach for OSR and components:

*   2019 and earlier - Census
*   2020 - tax growth rates from Census quarterly data; nontax based on state GDP estimate
*   2021 uses growth rates from a state governmental forecast, or inferred from those forecasts; nontax revenue assumed to grow at rate of state GDP
*   2022-2024 taxes are from simple models:
    +   income tax based upon state GDP, national capital gains, and its own history
    +   other tax categories based upon state GDP and the tax's own history
    +   nontax revenue assumed to grow at the rate of GDP
*   2025-2030 - all osr components are a constant % of GDP - their presumed long-term average (thus, all osr components grow at the same rate as state GDP)

Scenarios: Three factors determine a scenario

*   Which national economic forecast is used
*   Which equity forecast is used
*   Which governmental short-term forecast is used

Some combinations of these will not make sense (e.g., fedalt equity forecast might not make sense to combine with the CBO pre-covid economic forecast).

Currently I am using the Moody's December 2020 economic forecast as the best economic forecast. I know you prefer CBO July. We should discuss.

Here are the scenarios I am using (as of now):


  stabbr govtfc      econfc         equityfc      scenario

  NJ     ols_sep2020 moodys_dec2020 pew_covidbase baseline
  NJ     gov_aug2020 fedalt         pew_fedalt    downside
  NJ     gov_bmxleg  cbo_precovid   pew_covidbase precovid
  
  MA     bhi_oct2020 moodys_dec2020 pew_covidbase baseline


Selected issues and considerations:

*   Uses Census definitions of OSR and thus is different from what policymakers in NJ are familiar with
*   Assumes all revenue sources move from their 2021 values to longer term values, as % of GDP; historically, other tax revenue has tended to decline as % of GDP until policymakers explicitly raise it
*   Because the 2021 OSR estimate is based on a fixed governmental forecast, and is independent of the economic forecast, it may seem odd in relation to a severe-downturn economic forecast for FY 2021 - in particular, OSR as a percent of GDP is unusually high in 2021 when using the Moody's p90 forecast (because gdp is so low in that forecast)

## Data sources [details to come]

*   US GDP history: BEA NIPA tables, quarterly converted to state fiscal year (July-June)
*   State GDP history: BEA data, spliced NAICS and SIC; quarterly converted to state fiscal year, adjusted
*   US GDP forecasts:
    +   CBO pre-covid
